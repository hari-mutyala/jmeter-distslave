version: "3.9"

networks: 
 jmeter-net:
  driver: bridge
  ipam:
    config:
      - subnet: ${jmeter_subnet}
volumes:
  jmeter-vol:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '/opt/jmeter-vol'


services:
  slave1:
    image: hmutyala/jmeter-distslave
    networks:
      jmeter-net:
        ipv4_address: ${jmeterip_slave1}
    volumes:
      - jmeter-vol:/mnt/jmeter
    command:
      - -n -Jclient.rmi.localport=${jmeter_clientport} -Jserver.rmi.localport={jmeter_serverport}
      - -j /mnt/jmeter/slave_${jmeterip_slave1}.logdone
  

  slave2:
    image: hmutyala/jmeter-distslave
    networks:
      jmeter-net:
        ipv4_address: ${jmeterip_slave2}
    volumes:
     - jmeter-vol:/mnt/jmeter
    command:
      -n -Jclient.rmi.localport=${jmeter_clientport} -Jserver.rmi.localport={jmeter_serverport}
  
  slave3:
    image: hmutyala/jmeter-distslave
    networks:
      jmeter-net:
        ipv4_address: ${jmeterip_slave3}
    volumes:
      - jmeter-vol:/mnt/jmeter
    command:
      -n -Jclient.rmi.localport=${jmeter_clientport} -Jserver.rmi.localport={jmeter_serverport}
 
  master:
    image: hmutyala/jmeter-distmaster
    networks:
      jmeter-net:
        ipv4_address: ${jmeterip_master}
    volumes:
      - jmeter-vol:/mnt/jmeter    
    command:      
    #   -n -X -Jclient.rmi.localport=7000 -R ${jmeterip_slave1},${jmeterip_slave2},${jmeterip_slave3} -t ${jmeter_home}/bin/examples/${SCRIPT_NAME} -l ${jmeter_home}/bin/reports/${SCRIPT_NAME}_results.jtl -e -o ${JMETER_HOME}/bin/reports && cd ${JMETER_HOME}/bin/reports/ && zip -r ${SCRIPT_NAME}_results.zip . 
    depends_on:
      - slave1
      - slave2
      - slave3
